Зачем нужна БД:

1. Ведение статистики трейдов.
2. Статистика проскальзываний.
3. Запись исторических данных для анализа.

Первые два пункта полностью обеспечиваются при одной лишь таблице трейдов. Ведения в реальном времени не требуется. Достаточно первичной записи при отправке ордеров (даже не при исполнении главного ордера), только чтобы записать исходные данные для трейда. Остальное закрывается импортом брокерского отчёта. Синхронизация через API не требуется.

Третий пункт, очевидно, не привязан ни к каким событиям. Я либо запрашиваю эти данные у брокера по требованию, либо записываю их в реальном времени, но здесь не требуется управления транзакциями вообще, а восстановление оборванных данных при повторном подключении - элементарное.


А дальше?
---------

Дальше нам нужна коррекция ордеров по цене исполнения, и P/L, как общий, так и по позиции.

Коррекция ордеров в принципе возможна, потому что до исполнения главного ордера, можно хранить id связанных ордеров и по ним выполнить коррекцию. Даже если будет обрыв до исполнения главного ордера, я всего лишь потеряю коррекцию, что некритично.

P/L вычисляется только по исполненным ордерам. То есть при восстановлении после обрыва нужно запросить исполненные ордера. Да и вообще, имея открытую позицию нужно периодически запрашивать исполнение ордеров, хотя бы раз в секунду. Это если действовать тупо. 

Если действовать умно, нужно поддерживать список активных ордеров и по ним запрашивать исполнение, когда цена к ним приближается. Непросто, но всё равно не нужно ничего делать с БД. 

При обрыве запрашивается список активных ордеров и список исполнений, связывается с открытыми позициями и мы снова имеем актуальное состояние.

Обрыв на длительное время означает, что торговая сессия завершена и актуальный P/L нам уже не требуется.

В любом случае забота о целостности данных в базе - не требуется.

По одному Broker может быть лишь один текущий трейд и лишь один клиент (робот, или я), который этот трейд ведёт. Может быть передача управления от робота ко мне и обратно, но водитель в момент времени всегда один. Поэтому одновременная или несогласованная отправка ордеров исключена.

Отслеживать ордера в реальном времени можно и даже нужно, но не нужно ничего записывать в базу, заботиться о транзакциях и целостности данных. И это будет thread-safe.

Например, при отправке начальной связки ордеров, можно отслеживать их обычными колбэками. При частичном закрытии - это будет лимитный ордер, исполнение которого тоже можно отследить. При аварийном закрытии можно запрашивать исполнение спустя некоторое время или периодически до момента исполнения.

Во всех случаях у меня будет актуальный P/L по позиции.

Понятно, что нужен специальный класс для ведения позиции (и восстановления актуального состояния после обрыва).

И этот класс должен удалять активные, но неактуальные ордера. Например, при полном, штатном закрытии позиции, удаляются все активные ордера. При уходе цены от неисполненного, но активного ордера, его тоже надо закрывать (кроме обычных SL и TP).


Итого:
------

Сохранение ордеров в базу данных - отменяется. 

Механизм транзакций оставляем, он не мешает. 

Трейды записываются по факту отправки ордера (ну ок, можно получить подтверждение исполнения главного ордера и тогда уже записать). 

Для ведения статистики проскальзываний, нужно реализовать импорт брокерских отчётов, но это, быть может, уже в версии 2.1.

Никакой синхронизации с TWS, никакой головной боли по поводу целостности данных, никаких проблем при обрывах.

Но, при отслеживании позиций, я никуда не уйду ни от отслеживания ордеров, ни от запроса активных ордеров и исполнения, в том числе при восстановлении после обрывов.

И по крайней мере при полном закрытии позиции мне никто не мешает обновить статус трейда в базе. А значит, можно и нужно сохранять данные и по частичному закрытию, например, в дочерней таблице. Но это всё равно не полное отслеживание ордеров и не требует сложного управления транзакциями.